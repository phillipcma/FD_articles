{
  "id": 84074,
  "type": 1,
  "status": 2,
  "agent_id": 3763909,
  "created_at": "2013-05-10T08:05:04Z",
  "category_id": 81138,
  "folder_id": 139400,
  "title": "IPSec Configuration",
  "updated_at": "2020-12-17T09:46:29Z",
  "description": "<p><sub><strong><em><span style=\"font-size: 12px;\">Use of Proprietary Information and Copyright Notice.</span></em></strong><em><span style=\"font-size: 12px;\">\u00a0This document contains proprietary information that is to be used only by the Sippy Software, Inc. customers. Any unauthorized disclosure, copying, distribution, or use of this information is prohibited. (c) 2006-2019 Sippy Software, Inc. All rights reserved.</span></em></sub></p><p><br></p><p><strong>The capability for IPSec Configuration is available for Non-hosted solutions only. Contact sales@sippysoft.com for more information.</strong></p><p><br></p><p><strong><img src=\"https://s3.amazonaws.com/cdn.freshdesk.com/data/helpdesk/attachments/production/3046352833/original/gvITU8m_j1YTFVRMUVOoB7LoksWNNjMrrQ.png?1565168147\" class=\"fr-fic fr-dib\" data-filelink=\"https://s3.amazonaws.com/cdn.freshdesk.com/data/helpdesk/attachments/production/3046352833/original/gvITU8m_j1YTFVRMUVOoB7LoksWNNjMrrQ.png?1565168147\" data-fileid=\"3046352833\" data-uniquekey=\"1565168132910\"></strong></p><p align=\"center\"><strong>The IPSec solution has been tested with two major providers - Verizon and BT</strong></p><p><strong><sub><em><span style=\"font-size: 16px;\">Glossary:</span></em></sub></strong></p><p><span style=\"font-size: 16px;\"><sub>IKE_GW_IP - IP address of IKE gateway, should be pingable from the switch even if no tunnel is established. We need to connect this address to establish the tunnel<br></sub></span></p><p><span style=\"font-size: 16px;\"><sub>REMOTE_GW_NET/YY - Remote Gateway's subnet for signalling, traffic should be routed to the IPs named through the IPSec tunnel.<br></sub></span></p><p><span style=\"font-size: 16px;\"><sub>SIPPY_IP - the IP assigned to the Sippy server that the IPSec provider expects to get the encrypted packets from. \u00a0On the provider's side the SIPPY_IP should be allowed for the IKE_GW_IP<br></sub></span></p><p><sub><span style=\"font-size: 16px;\">SIPPY_NET/32 - subnet of the Sippy IP addresses that Verizon authorized for sending traffic back.\u00a0</span></sub></p><p><sub><u><strong><span style=\"font-size: 16px; background-color: rgb(255, 255, 0);\">Formerly it used to be the subnet, now it could be the YOUR_IP/32</span></strong></u><em><br></em></sub></p><p><br></p><p align=\"center\"><br></p><p><strong>To be able to setup IPSec we require the following information:</strong></p><ul><li>IKE gateway IP address</li><li>Remote Gateway's subnet</li><li>SIP signalling IPs that should be reachable after setting up the tunnel</li><li>pre-shared key for each IKE gateway IP address</li><li><p>List of Sippy IPs that are authorized to send traffic to the tunnel - this could be a subnet or one IP for each IKE_GW_IP</p></li><li><p><u>proposed configuration for each phase</u>, fully tested combinations are:</p></li></ul><blockquote>OPTION 1: p1 = \"pre-g2-3des-md5\" # p2 = \"g2-3des-md5\"<br>OPTION 2: p1 = \"pre-g5-3des-sha1\" # p2 = \"g5-3des-sha1\"</blockquote><p><strong>Legend / Glossary: (This legend assumes you have chosen OPTION 1 from the above list.)</strong></p><p><strong><u>p1 = \"Phase 1\" settings.</u></strong></p><p>pre = The \"authentication method\" in use. pre stands for 'Pre-Shared'.</p><p>g2 = The \"Diffy Hillman Group\" used. g2 stands for 'Group 2'.</p><p>3des = The \"encryption method\" used. 3des stands for 'Triple Data Encryption Algorithm'.</p><p>md5 = The \"hash method\" used. md5 stands for 'Message-Digest Algorithm 5'.</p><p>---------------------------------------</p><p><u><strong>p2 = \"Phase 2\" settings.</strong></u></p><p>g2 = The \"Diffy Hillman Group\" used. g2 stands for 'Group 2'.</p><p>3des = The \"encryption method\" used. 3des stands for 'Triple Data Encryption Algorithm'.</p><p>md5 = The \"hash method\" used. md5 stands for 'Message-Digest Algorithm 5'.</p><p><br></p><h3>1. Install <em><strong>ports/security/ipsec-tools [latest version of Sippy goes with this package installed, so you can skip this step]</strong></em></h3><p><br></p><h3>2. Create <strong><em>/etc/ipsec.rules</em></strong>:</h3><pre contenteditable=\"false\" data-code-brush=\"text\" rel=\"highlighter\">flush;\nspdflush;\nspdadd SIPPY_NET/32 REMOTE_GW_NET/YY any -P out ipsec\n  esp/tunnel/SIPPY_IP-IKE_GW_IP/require;\nspdadd REMOTE_GW_NET/YY SIPPY_NET/32 any -P in ipsec\n  esp/tunnel/IKE_GW_IP-SIPPY_IP/require;</pre><p><br></p><p># If you have 2+ IKE_GW_IP then the step should be repeated with the distinctive data in the same file</p><p><br></p><p><strong>Explanation for outgoing part:</strong></p><p>For outgoing packets of any protocol from the <span style=\"background-color: rgb(255, 255, 0);\">SIPPY_NET/32</span><span style=\"background-color: rgb(255, 255, 255);\">\u00a0</span>network to the <span style=\"background-color: rgb(155, 187, 89);\">REMOTE_GW_NET/YY</span><span style=\"background-color: rgb(255, 255, 255);\">\u00a0network\u00a0</span></p><p>it is required to use (esp) encryption through the tunnel, using the encryption on host <span style=\"background-color: rgb(255, 255, 0);\">SIPPY_IP</span></p><p>and addressing the encrypted packet to the host <span style=\"background-color: rgb(155, 187, 89);\">IKE_GW_IP</span></p><p><strong>Explanation for incoming part:</strong></p><p>For outgoing packets of any protocol from the <span style=\"background-color: rgb(155, 187, 89);\">REMOTE_GW_NET/YY</span> network to the <span style=\"background-color: rgb(255, 255, 0);\">SIPPY_NET/32</span></p><p>network, it is required that the traffic be (esp) encrypted through the tunnel, having been encrypted on host <span style=\"background-color: rgb(155, 187, 89);\">IKE_GW_IP</span></p><p>and received encrypted on <span style=\"background-color: rgb(255, 255, 0);\">SIPPY_IP</span></p><p><span style=\"background-color: rgb(255, 255, 255);\"><br></span></p><p><strong><span style=\"background-color: rgb(255, 255, 255);\">Note1:</span></strong></p><p><span style=\"background-color: rgb(255, 255, 255);\">There could be multiple rules for different <span style=\"background-color: rgb(155, 187, 89);\">REMOTE_GW_NETs</span> with different corresponding <span style=\"background-color: rgb(155, 187, 89);\">IKE_GW_IP</span><br></span></p><p><strong>Note2:</strong></p><p>Pay attention to spaces, there should be 2 spaces before esp, no more, no less</p><p><strong>Note3:</strong></p><p><strong><u>Likely the XX subnet of the SIPPY_NET should be /32, that's how it works in most cases</u><br></strong></p><p><br></p><h3>3. Create <em><strong>/usr/local/etc/racoon/psk.txt</strong></em>:</h3><blockquote>IKE_GW_IP SHARED_KEY</blockquote><p><br></p><h3>4. Create <strong><em>/usr/local/etc/racoon/racoon.conf</em></strong>:</h3><pre class=\"code-large\" contenteditable=\"false\" rel=\"highlighter\">path pre_shared_key \"/usr/local/etc/racoon/psk.txt\" ;\ntimer\n{\n        phase1 28800 sec; # max time for the phase to complete\n        phase2 3600 sec; # max time for the phase to complete\n        interval 1 min; # the interval to resend\n}\nlisten\n{\n        isakmp  SIPPY_IP; # Force racoon to listen only on this address, you can specify the port with \" [port]\"\n        strict_address; # Require all addresses to be bound\n}\n\n# IKE gateway1 address, phase 1 is defined here\n\nremote IKE_GW_IP # custom port can be set here (default is 500), e.g. \"[2500]\"\n{\n        my_identifier address SIPPY_IP; # identifier to be sent to remote host\n        peers_identifier address IKE_GW_IP;\n        exchange_mode main; # main, aggressive or base\n        passive         off; # if you want to initiate the negotiation, set to off\n        proposal_check  obey; # the responder will obey the initiator anytime\n        lifetime time 15 min; # sec,min,hour, proposal of phase 1 lifetime\n\n        # phase 1 proposal\n        proposal\n        {\n                encryption_algorithm 3des; # encryption for ph1, either des,3des,blowfish,cast128\n                hash_algorithm md5; # hash for ph1, either md5,sha1\n                authentication_method pre_shared_key; # authentication for ph1\n                dh_group 2; # Diffie-Hellman exp, either modp768=1, modp1024=2,modp1536=5\n        }\n}\n\n## remote IKE_GW_IP_2 # case you have 2+ IPsec GWs\n## {\n##        my_identifier address SIPPY_IP; # identifier to be sent to remote host\n##        peers_identifier address IKE_GW_IP_2;\n##        exchange_mode main; # main, aggressive or base\n##        passive         off; # if you want to initiate the negotiation, set to off\n##        proposal_check  obey; # the responder will obey the initiator anytime\n##        lifetime time 15 min; # sec,min,hour, proposal of phase 1 lifetime\n##\n##        # phase 1 proposal\n##        proposal\n##        {\n##                encryption_algorithm 3des; # encryption for ph1, either des,3des,blowfish,cast128,aes128\n##                hash_algorithm md5; # hash for ph1, either md5,sha1\n##                authentication_method pre_shared_key; # authentication for ph1\n##                dh_group 2; # Diffie-Hellman exp, either modp768=1, modp1024=2,modp1536=5\n##        }\n## }\n\n# Phase2, ISAKMP-SA\n\nsainfo anonymous\n{\n        pfs_group 2; # Diffie-Hellman exp, either modp768=1, modp1024=2,modp1536=5\n        encryption_algorithm 3des; # encryption for ph2, either des,3des,des_iv64,des_iv32,rc5,rc4,idea,3idea,cast128,blowfish,null_enc,twofish,rijndael,aes128\n        authentication_algorithm hmac_md5 ; # authentication for ph2, either des,3des,des_iv64,des_iv32,hmac_md5,hmac_sha1,non_auth\n        compression_algorithm deflate;\n        lifetime time 15 min; # sec,min,hour, proposal of phase 12 lifetime\n}\n\n## sainfo address SIPPY_IP/XX any address REMOTE_GW_NET/YY any # case you have 2+ IPsec GWs\n## {\n##        pfs_group 2; # Diffie-Hellman exp, either modp768=1, modp1024=2,modp1536=5\n##        encryption_algorithm 3des; # encryption for ph2, either des,3des,des_iv64,des_iv32,rc5,rc4,idea,3idea,cast128,blowfish,null_enc,twofish,rijndael\n##        authentication_algorithm hmac_sha1 ; # authentication for ph2, either des,3des,des_iv64,des_iv32,hmac_md5,hmac_sha1,non_auth\n##        compression_algorithm deflate;\n##        lifetime time 3600 sec; # sec,min,hour, proposal of phase 12 lifetime\n## }\n\n\n# Enable logging if needed. Available options: notify,debug,debug2\n\n#log debug2;</pre><p>\u00a0</p><p><br></p><h3>5. Add commands to load racoon and ipsec config into <strong><em>rc.conf</em></strong>:</h3><blockquote>ipsec_enable=\"YES\"<br>ipsec_file=\"/etc/ipsec.rules\"<br>racoon_enable=\"YES\"<br>racoon_flags=\"-l /var/log/racoon.log\"</blockquote><p><br></p><h3>6. Make sure psk.txt has the correct permissions:\u00a0</h3><blockquote><p>$ sudo chmod 600 /usr/local/etc/racoon/psk.txt</p></blockquote><p><br></p><h3>7. Load ipsec rules - it shouldn't be running in the processes, start racoon - it should be running as a daemon:\u00a0</h3><blockquote>$ sudo /etc/rc.d/ipsec start<br>$ sudo /usr/local/etc/rc.d/racoon restart<br>$ sudo /usr/local/etc/rc.d/racoon status</blockquote><p>Sometimes it might fail to start with the following error message:\u00a0</p><blockquote>/usr/local/etc/rc.d/racoon: WARNING: /var/db/racoon is not a directory.</blockquote><p>In such case create this directory and try to start it again:\u00a0</p><blockquote>$ sudo mkdir /var/db/racoon<br>$ sudo /usr/local/etc/rc.d/racoon start</blockquote><p>Image with the example is attached.</p><p><br></p><h3>8. To check the tunnel you can ping one of the IPs from Verizon net \u00a0after establishing the tunnel. SIP IPs are preferable, the target IP you ping \u00a0should be located in <span style=\"background-color: rgb(155, 187, 89);\">REMOTE_GW_NET/YY</span></h3><blockquote>$ ping -S SIPPY_IP SIP_SIGNALLING_IP</blockquote><h3><br></h3><p><br></p><p><span style=\"font-size: 16px;\">9. Check that the tunnel has been established successfully, expected output:</span></p><blockquote># setkey -D<br>SIPPY_IP IKE_GW_IP<br>esp mode=tunnel spi=1197346408(0x475e0e68) reqid=0(0x00000000)<br>E: 3des-cbc 1e14930b 24956ab2 9b59f0c5 b9663dbe ddddc15a 12709f72<br>A: hmac-sha1 f3bcb876 12d33057 55d50c6f 2fb64dbb 38f91d72<br>seq=0x0000000a replay=4 flags=0x00000000 state=mature<br>created: Nov 6 17:55:24 2015 current: Nov 6 18:16:18 2015<br>diff: 1254(s) hard: 28800(s) soft: 23040(s)<br>last: Nov 6 17:55:34 2015 hard: 0(s) soft: 0(s)<br>current: 1360(bytes) hard: 0(bytes) soft: 0(bytes)<br>allocated: 10 hard: 0 soft: 0<br>sadb_seq=1 pid=61849 refcnt=2<br>IKE_GW_IP SIPPY_IP<br>esp mode=tunnel spi=54124353(0x0339df41) reqid=0(0x00000000)<br>E: 3des-cbc d35278ac cb8f9821 944a8b8e 53cc0b67 28fce357 75208117<br>A: hmac-sha1 22ae0a4d 28cd25bf 7c4b78a9 f19c8153 2f97a2ba<br>seq=0x0000000a replay=4 flags=0x00000000 state=mature<br>created: Nov 6 17:55:24 2015 current: Nov 6 18:16:18 2015<br>diff: 1254(s) hard: 28800(s) soft: 23040(s)<br>last: Nov 6 17:55:34 2015 hard: 0(s) soft: 0(s)<br>current: 1040(bytes) hard: 0(bytes) soft: 0(bytes)<br>allocated: 10 hard: 0 soft: 0<br>\u00a0sadb_seq=0 pid=61849 refcnt=1</blockquote><p><span style=\"font-size: 16px;\">\u00a010. Disable debug in racoon.conf and restart racoon, either comment that option out or set it to notify.</span></p><p><br></p><p><br></p><h2>Additional information:</h2><ul><li>it's possible to run racoon in the max debug verbose mode so that the output is placed to the console.</li></ul><blockquote><p># racoon -v -F -dd -f /usr/local/etc/racoon/racoon.conf</p></blockquote><p>-v for verbose output, more debug level</p><p>-f specify the file with the racoon config</p><p>-d for the 1st level of debug. Multiple d are used for enhancing the debug</p><p>-F run racoon in the foreground.</p><p>-l logfile - if needed, print the output to the log</p><p><br></p><p>they could be also used as the racoon flags in the rc.conf. For more flags check\u00a0</p><blockquote><p>$ man racoon</p></blockquote><ul><li>The result of line 18: File exists.</li></ul><p>this is caused by mistakes in /etc/ipsec.rules, like 3 spaces instead of 2 before <strong>esp</strong>, or two rules leading from the same <span style=\"background-color: rgb(255, 255, 0);\">SIPPY_NET/XX</span> to the same <span style=\"background-color: rgb(155, 187, 89);\">REMOTE_GW_NET/YY</span></p><p>You can also try restarting ipsec to clear it out:</p><blockquote><p>$ sudo /etc/rc.d/ipsec start</p></blockquote><ul><li>Racoon's documentation:</li></ul><p><a href=\"http://www.kame.net/racoon/racoon.conf.5\" target=\"\">http://www.kame.net/racoon/racoon.conf.5</a></p><ul><li>If you need to configure more then one IKE gateway, add the separate remote followed with the sainfo sections in the racoon conf per each IKE gateway</li></ul><p><strong>----</strong></p><p><strong>Racoon log troubleshooting:</strong></p><p><strong>----<br></strong></p><p><strong>1. The incorrect encryption_algorithm on Phase 1 has been chosen, it does not match the server's configuration.</strong></p><blockquote><p>ERROR: notification NO-PROPOSAL-CHOSEN received in unencrypted informational exchange.</p></blockquote><p><strong>2. The YOUR_NET/XX is configured with incorrect subnet. Try /32 for it, and restart ipsec and racoon</strong></p><blockquote><p>ERROR: notification INVALID-ID-INFORMATION received in informational exchange.<br>ERROR: error message: '&amp;. ;x % }- @ SME 4 ( _a8 p C` s 2 PS _ f o 0q `] D5 &gt; ] \"R L9 C Z : :\\ 4 , v b k I x ^5 h*\\ N [0 ;W 8 x @ z e l e f* 3 6 0 | S2 2 &amp; 0 i9 [/r [a %0O &gt; @ '.</p></blockquote><p><strong>3. The misconfiguration of used port for either local of remote address or encryption on phase1:</strong></p><blockquote>DEBUG2: CHKPH1THERE: no established ph1 handler found</blockquote><p><strong>The following lines should be corrected with either aproper port, or the port should be removed in order to use the default one</strong></p><p><br></p><blockquote>isakmp YOUR_IP [port] # local IP<p><br></p>remote VERIZON_IP [port] # remote IP</blockquote><p><strong>4. The misconfiguration of ipsec.rules or firewall related issue:</strong></p><blockquote>ERROR: phase2 negotiation failed due \u00a0to time up waiting for phase1. ESP IKE_GW_IP[0]-&gt;SIPPY_IP[0]<br>2015-02-12 06:25:43: INFO: delete phase 2 handler.<br>2015-02-12 06:26:02: <strong>ERROR: phase1 negotiation failed due to time up</strong>. b20adad2a567eace:0000000000000000</blockquote><p><br></p><p><br></p><p><strong>The IKEv1 process is demonstrated in the following diagram:\u00a0</strong></p><p><br></p><p><img src=\"https://s3.amazonaws.com/cdn.freshdesk.com/data/helpdesk/attachments/production/3046387583/original/rZhpw9TyDJHep2jAVIvjWJevh77qHGL8yw.png?1565265271\" class=\"fr-fic fr-dib fr-fil\" data-filelink=\"https://s3.amazonaws.com/cdn.freshdesk.com/data/helpdesk/attachments/production/3046387583/original/rZhpw9TyDJHep2jAVIvjWJevh77qHGL8yw.png?1565265271\" data-fileid=\"3046387583\" data-uniquekey=\"1565265082476\" style=\"width: 470px;\"></p><p><br></p><p><br></p>",
  "description_text": " Use of Proprietary Information and Copyright Notice.\u00a0This document contains proprietary information that is to be used only by the Sippy Software, Inc. customers. Any unauthorized disclosure, copying, distribution, or use of this information is prohibited. (c) 2006-2019 Sippy Software, Inc. All rights reserved.     The capability for IPSec Configuration is available for Non-hosted solutions only. Contact sales@sippysoft.com for more information.       The IPSec solution has been tested with two major providers - Verizon and BT  Glossary:  IKE_GW_IP - IP address of IKE gateway, should be pingable from the switch even if no tunnel is established. We need to connect this address to establish the tunnel   REMOTE_GW_NET/YY - Remote Gateway's subnet for signalling, traffic should be routed to the IPs named through the IPSec tunnel.   SIPPY_IP - the IP assigned to the Sippy server that the IPSec provider expects to get the encrypted packets from. \u00a0On the provider's side the SIPPY_IP should be allowed for the IKE_GW_IP   SIPPY_NET/32 - subnet of the Sippy IP addresses that Verizon authorized for sending traffic back.\u00a0  Formerly it used to be the subnet, now it could be the YOUR_IP/32         To be able to setup IPSec we require the following information:   IKE gateway IP address  Remote Gateway's subnet  SIP signalling IPs that should be reachable after setting up the tunnel  pre-shared key for each IKE gateway IP address   List of Sippy IPs that are authorized to send traffic to the tunnel - this could be a subnet or one IP for each IKE_GW_IP    proposed configuration for each phase, fully tested combinations are:    OPTION 1: p1 = \"pre-g2-3des-md5\" # p2 = \"g2-3des-md5\" OPTION 2: p1 = \"pre-g5-3des-sha1\" # p2 = \"g5-3des-sha1\"  Legend / Glossary: (This legend assumes you have chosen OPTION 1 from the above list.)  p1 = \"Phase 1\" settings.  pre = The \"authentication method\" in use. pre stands for 'Pre-Shared'.  g2 = The \"Diffy Hillman Group\" used. g2 stands for 'Group 2'.  3des = The \"encryption method\" used. 3des stands for 'Triple Data Encryption Algorithm'.  md5 = The \"hash method\" used. md5 stands for 'Message-Digest Algorithm 5'.  ---------------------------------------  p2 = \"Phase 2\" settings.  g2 = The \"Diffy Hillman Group\" used. g2 stands for 'Group 2'.  3des = The \"encryption method\" used. 3des stands for 'Triple Data Encryption Algorithm'.  md5 = The \"hash method\" used. md5 stands for 'Message-Digest Algorithm 5'.     1. Install ports/security/ipsec-tools [latest version of Sippy goes with this package installed, so you can skip this step]     2. Create /etc/ipsec.rules:  flush;\nspdflush;\nspdadd SIPPY_NET/32 REMOTE_GW_NET/YY any -P out ipsec\n  esp/tunnel/SIPPY_IP-IKE_GW_IP/require;\nspdadd REMOTE_GW_NET/YY SIPPY_NET/32 any -P in ipsec\n  esp/tunnel/IKE_GW_IP-SIPPY_IP/require;     # If you have 2+ IKE_GW_IP then the step should be repeated with the distinctive data in the same file     Explanation for outgoing part:  For outgoing packets of any protocol from the SIPPY_NET/32\u00a0network to the REMOTE_GW_NET/YY\u00a0network\u00a0  it is required to use (esp) encryption through the tunnel, using the encryption on host SIPPY_IP  and addressing the encrypted packet to the host IKE_GW_IP  Explanation for incoming part:  For outgoing packets of any protocol from the REMOTE_GW_NET/YY network to the SIPPY_NET/32  network, it is required that the traffic be (esp) encrypted through the tunnel, having been encrypted on host IKE_GW_IP  and received encrypted on SIPPY_IP     Note1:  There could be multiple rules for different REMOTE_GW_NETs with different corresponding IKE_GW_IP   Note2:  Pay attention to spaces, there should be 2 spaces before esp, no more, no less  Note3:  Likely the XX subnet of the SIPPY_NET should be /32, that's how it works in most cases      3. Create /usr/local/etc/racoon/psk.txt:  IKE_GW_IP SHARED_KEY     4. Create /usr/local/etc/racoon/racoon.conf:  path pre_shared_key \"/usr/local/etc/racoon/psk.txt\" ;\ntimer\n{\n        phase1 28800 sec; # max time for the phase to complete\n        phase2 3600 sec; # max time for the phase to complete\n        interval 1 min; # the interval to resend\n}\nlisten\n{\n        isakmp  SIPPY_IP; # Force racoon to listen only on this address, you can specify the port with \" [port]\"\n        strict_address; # Require all addresses to be bound\n}\n\n# IKE gateway1 address, phase 1 is defined here\n\nremote IKE_GW_IP # custom port can be set here (default is 500), e.g. \"[2500]\"\n{\n        my_identifier address SIPPY_IP; # identifier to be sent to remote host\n        peers_identifier address IKE_GW_IP;\n        exchange_mode main; # main, aggressive or base\n        passive         off; # if you want to initiate the negotiation, set to off\n        proposal_check  obey; # the responder will obey the initiator anytime\n        lifetime time 15 min; # sec,min,hour, proposal of phase 1 lifetime\n\n        # phase 1 proposal\n        proposal\n        {\n                encryption_algorithm 3des; # encryption for ph1, either des,3des,blowfish,cast128\n                hash_algorithm md5; # hash for ph1, either md5,sha1\n                authentication_method pre_shared_key; # authentication for ph1\n                dh_group 2; # Diffie-Hellman exp, either modp768=1, modp1024=2,modp1536=5\n        }\n}\n\n## remote IKE_GW_IP_2 # case you have 2+ IPsec GWs\n## {\n##        my_identifier address SIPPY_IP; # identifier to be sent to remote host\n##        peers_identifier address IKE_GW_IP_2;\n##        exchange_mode main; # main, aggressive or base\n##        passive         off; # if you want to initiate the negotiation, set to off\n##        proposal_check  obey; # the responder will obey the initiator anytime\n##        lifetime time 15 min; # sec,min,hour, proposal of phase 1 lifetime\n##\n##        # phase 1 proposal\n##        proposal\n##        {\n##                encryption_algorithm 3des; # encryption for ph1, either des,3des,blowfish,cast128,aes128\n##                hash_algorithm md5; # hash for ph1, either md5,sha1\n##                authentication_method pre_shared_key; # authentication for ph1\n##                dh_group 2; # Diffie-Hellman exp, either modp768=1, modp1024=2,modp1536=5\n##        }\n## }\n\n# Phase2, ISAKMP-SA\n\nsainfo anonymous\n{\n        pfs_group 2; # Diffie-Hellman exp, either modp768=1, modp1024=2,modp1536=5\n        encryption_algorithm 3des; # encryption for ph2, either des,3des,des_iv64,des_iv32,rc5,rc4,idea,3idea,cast128,blowfish,null_enc,twofish,rijndael,aes128\n        authentication_algorithm hmac_md5 ; # authentication for ph2, either des,3des,des_iv64,des_iv32,hmac_md5,hmac_sha1,non_auth\n        compression_algorithm deflate;\n        lifetime time 15 min; # sec,min,hour, proposal of phase 12 lifetime\n}\n\n## sainfo address SIPPY_IP/XX any address REMOTE_GW_NET/YY any # case you have 2+ IPsec GWs\n## {\n##        pfs_group 2; # Diffie-Hellman exp, either modp768=1, modp1024=2,modp1536=5\n##        encryption_algorithm 3des; # encryption for ph2, either des,3des,des_iv64,des_iv32,rc5,rc4,idea,3idea,cast128,blowfish,null_enc,twofish,rijndael\n##        authentication_algorithm hmac_sha1 ; # authentication for ph2, either des,3des,des_iv64,des_iv32,hmac_md5,hmac_sha1,non_auth\n##        compression_algorithm deflate;\n##        lifetime time 3600 sec; # sec,min,hour, proposal of phase 12 lifetime\n## }\n\n\n# Enable logging if needed. Available options: notify,debug,debug2\n\n#log debug2;  \u00a0     5. Add commands to load racoon and ipsec config into rc.conf:  ipsec_enable=\"YES\" ipsec_file=\"/etc/ipsec.rules\" racoon_enable=\"YES\" racoon_flags=\"-l /var/log/racoon.log\"     6. Make sure psk.txt has the correct permissions:\u00a0   $ sudo chmod 600 /usr/local/etc/racoon/psk.txt      7. Load ipsec rules - it shouldn't be running in the processes, start racoon - it should be running as a daemon:\u00a0  $ sudo /etc/rc.d/ipsec start $ sudo /usr/local/etc/rc.d/racoon restart $ sudo /usr/local/etc/rc.d/racoon status  Sometimes it might fail to start with the following error message:\u00a0  /usr/local/etc/rc.d/racoon: WARNING: /var/db/racoon is not a directory.  In such case create this directory and try to start it again:\u00a0  $ sudo mkdir /var/db/racoon $ sudo /usr/local/etc/rc.d/racoon start  Image with the example is attached.     8. To check the tunnel you can ping one of the IPs from Verizon net \u00a0after establishing the tunnel. SIP IPs are preferable, the target IP you ping \u00a0should be located in REMOTE_GW_NET/YY  $ ping -S SIPPY_IP SIP_SIGNALLING_IP        9. Check that the tunnel has been established successfully, expected output:  # setkey -D SIPPY_IP IKE_GW_IP esp mode=tunnel spi=1197346408(0x475e0e68) reqid=0(0x00000000) E: 3des-cbc 1e14930b 24956ab2 9b59f0c5 b9663dbe ddddc15a 12709f72 A: hmac-sha1 f3bcb876 12d33057 55d50c6f 2fb64dbb 38f91d72 seq=0x0000000a replay=4 flags=0x00000000 state=mature created: Nov 6 17:55:24 2015 current: Nov 6 18:16:18 2015 diff: 1254(s) hard: 28800(s) soft: 23040(s) last: Nov 6 17:55:34 2015 hard: 0(s) soft: 0(s) current: 1360(bytes) hard: 0(bytes) soft: 0(bytes) allocated: 10 hard: 0 soft: 0 sadb_seq=1 pid=61849 refcnt=2 IKE_GW_IP SIPPY_IP esp mode=tunnel spi=54124353(0x0339df41) reqid=0(0x00000000) E: 3des-cbc d35278ac cb8f9821 944a8b8e 53cc0b67 28fce357 75208117 A: hmac-sha1 22ae0a4d 28cd25bf 7c4b78a9 f19c8153 2f97a2ba seq=0x0000000a replay=4 flags=0x00000000 state=mature created: Nov 6 17:55:24 2015 current: Nov 6 18:16:18 2015 diff: 1254(s) hard: 28800(s) soft: 23040(s) last: Nov 6 17:55:34 2015 hard: 0(s) soft: 0(s) current: 1040(bytes) hard: 0(bytes) soft: 0(bytes) allocated: 10 hard: 0 soft: 0 \u00a0sadb_seq=0 pid=61849 refcnt=1  \u00a010. Disable debug in racoon.conf and restart racoon, either comment that option out or set it to notify.        Additional information:   it's possible to run racoon in the max debug verbose mode so that the output is placed to the console.    # racoon -v -F -dd -f /usr/local/etc/racoon/racoon.conf   -v for verbose output, more debug level  -f specify the file with the racoon config  -d for the 1st level of debug. Multiple d are used for enhancing the debug  -F run racoon in the foreground.  -l logfile - if needed, print the output to the log     they could be also used as the racoon flags in the rc.conf. For more flags check\u00a0   $ man racoon    The result of line 18: File exists.   this is caused by mistakes in /etc/ipsec.rules, like 3 spaces instead of 2 before esp, or two rules leading from the same SIPPY_NET/XX to the same REMOTE_GW_NET/YY  You can also try restarting ipsec to clear it out:   $ sudo /etc/rc.d/ipsec start    Racoon's documentation:   http://www.kame.net/racoon/racoon.conf.5   If you need to configure more then one IKE gateway, add the separate remote followed with the sainfo sections in the racoon conf per each IKE gateway   ----  Racoon log troubleshooting:  ----   1. The incorrect encryption_algorithm on Phase 1 has been chosen, it does not match the server's configuration.   ERROR: notification NO-PROPOSAL-CHOSEN received in unencrypted informational exchange.   2. The YOUR_NET/XX is configured with incorrect subnet. Try /32 for it, and restart ipsec and racoon   ERROR: notification INVALID-ID-INFORMATION received in informational exchange. ERROR: error message: '&. ;x % }- @ SME 4 ( _a8 p C` s 2 PS _ f o 0q `] D5 > ] \"R L9 C Z : :\\ 4 , v b k I x ^5 h*\\ N [0 ;W 8 x @ z e l e f* 3 6 0 | S2 2 & 0 i9 [/r [a %0O > @ '.   3. The misconfiguration of used port for either local of remote address or encryption on phase1:  DEBUG2: CHKPH1THERE: no established ph1 handler found  The following lines should be corrected with either aproper port, or the port should be removed in order to use the default one     isakmp YOUR_IP [port] # local IP   remote VERIZON_IP [port] # remote IP  4. The misconfiguration of ipsec.rules or firewall related issue:  ERROR: phase2 negotiation failed due \u00a0to time up waiting for phase1. ESP IKE_GW_IP[0]->SIPPY_IP[0] 2015-02-12 06:25:43: INFO: delete phase 2 handler. 2015-02-12 06:26:02: ERROR: phase1 negotiation failed due to time up. b20adad2a567eace:0000000000000000        The IKEv1 process is demonstrated in the following diagram:\u00a0            ",
  "seo_data": {
    "meta_title": "",
    "meta_description": "",
    "meta_keywords": ""
  },
  "tags": [],
  "attachments": [
    {
      "id": 5556983,
      "name": "EIN_IPsec_CallFlow.jpg",
      "content_type": "image/jpeg",
      "size": 74900,
      "created_at": "2013-05-10T08:09:04Z",
      "updated_at": "2013-05-10T08:09:04Z",
      "attachment_url": "https://s3.amazonaws.com/cdn.freshdesk.com/data/helpdesk/attachments/production/5556983/original/EIN_IPsec_CallFlow.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAS6FNSMY2XLZULJPI%2F20211012%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20211012T214408Z&X-Amz-Expires=300&X-Amz-SignedHeaders=host&X-Amz-Signature=e0dd11737323e95a074ee4eda50338aa016814f551659858cdb55552819932c1",
      "thumb_url": "https://s3.amazonaws.com/cdn.freshdesk.com/data/helpdesk/attachments/production/5556983/thumb/EIN_IPsec_CallFlow.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAS6FNSMY2XLZULJPI%2F20211012%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20211012T214408Z&X-Amz-Expires=300&X-Amz-SignedHeaders=host&X-Amz-Signature=b971be02d85915f46e6e567cfaef240e8362b0cdb0c7f394d4f434dd9f26ed70"
    }
  ],
  "cloud_files": [],
  "thumbs_up": 2,
  "thumbs_down": 1,
  "hits": 2715,
  "suggested": 0,
  "feedback_count": 0,
  "collaboration": {
    "convo_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJUeXBlIjoiYXJ0aWNsZSIsIkNvbnZvSWQiOiI4NDA3NC1lbiIsIlVzZXJJZCI6IjMwMTIwODk1MjQiLCJleHAiOjE2MzUzNzEwNDh9.nhrzfM6nLfn1v1gyq_L5TMsU9prfLZQBET5fvs0DEeE"
  }
}